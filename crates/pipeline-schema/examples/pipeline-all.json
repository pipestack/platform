{
  "$schema": "../schemas/main.schema.json",
  "pipeline": {
    "name": "pipeline-all",
    "version": "0.1.0",
    "description": "A pipeline config that includes all possible options",
    "steps": [
      {
        "name": "http-source",
        "type": "in-http",
        "instances": 1,
        "config": {
          "port": 8080,
          "path": "/data",
          "methods": ["POST"],
          "cors": true,
          "rate_limit": {
            "requests_per_second": 100,
            "burst": 200
          }
        }
      },
      {
        "name": "kafka-source",
        "type": "in-kafka",
        "instances": 2,
        "config": {
          "brokers": ["kafka:9092"],
          "topic": "incoming-data",
          "consumer_group": "pipeline-consumers",
          "offset": "latest",
          "batch_size": 100
        }
      },
      {
        "name": "s3-source",
        "type": "in-s3",
        "config": {
          "bucket": "data-lake",
          "prefix": "raw/",
          "poll_interval": "5m",
          "file_pattern": ".*\\.json$",
          "region": "us-west-2"
        }
      },
      {
        "name": "process-data",
        "type": "processor",
        "source": "file:///path/to/data-processor.wasm",
        "instances": 4,
        "depends_on": ["http-source", "kafka-source", "s3-source"]
      },
      {
        "name": "transform-data",
        "type": "processor",
        "source": "file:///path/to/data-transformer.wasm",
        "depends_on": ["process-data"]
      },
      {
        "name": "kafka-sink",
        "type": "out-kafka",
        "depends_on": ["transform-data"],
        "config": {
          "brokers": ["kafka:9092"],
          "topic": "processed-data",
          "partition_key": "id",
          "compression": "snappy",
          "acks": "all"
        }
      },
      {
        "name": "s3-sink",
        "type": "out-s3",
        "depends_on": ["transform-data"],
        "config": {
          "bucket": "data-lake",
          "prefix": "processed/",
          "file_format": "parquet",
          "compression": "snappy",
          "partition_by": ["date", "region"],
          "max_file_size": "500MB",
          "region": "us-west-2"
        }
      },
      {
        "name": "postgres-sink",
        "type": "out-postgres",
        "depends_on": ["transform-data"],
        "config": {
          "connection_string": "postgresql://user:password@postgres:5432/database",
          "table": "processed_data",
          "batch_size": 50,
          "upsert": true,
          "conflict_columns": ["id"],
          "schema": "public"
        }
      }
    ],
    "messaging": {
      "provider": "nats",
      "instances": 3
    }
  }
}